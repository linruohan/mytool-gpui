[build]
rustc-wrapper = "sccache"  # 确保 sccache 被使用

[profile.dev]
codegen-units = 256        # 最大化并行编译
incremental = true         # 增量编译

[profile.dev.package]
# 对重量级依赖使用最高优化级别，减少运行时开销
# 这些依赖编译慢但运行频繁，值得优化
# 注意：Cargo 不支持 * 通配符，需要逐个列出

# GPUI 相关重量级依赖
wgpu = { opt-level = 3 }
wgpu-core = { opt-level = 3 }
wgpu-hal = { opt-level = 3 }
naga = { opt-level = 3 }
cosmic-text = { opt-level = 3 }
resvg = { opt-level = 3 }
usvg = { opt-level = 3 }
rustybuzz = { opt-level = 3 }
taffy = { opt-level = 3 }
ttf-parser = { opt-level = 3 }

# gpui-component 带来的重量级依赖
tree-sitter = { opt-level = 3 }
tree-sitter-json = { opt-level = 3 }
markdown = { opt-level = 3 }
html5ever = { opt-level = 3 }
markup5ever_rcdom = { opt-level = 3 }
regex = { opt-level = 3 }
regex-automata = { opt-level = 3 }
regex-syntax = { opt-level = 3 }

[unstable]
# 启用 Cranelift 代码生成后端
codegen-backend = true

# 开发模式使用 Cranelift（仅在非 Windows MSVC 或明确需要时使用）
# 注意：Cranelift 主要用于 Debug 模式，Release 模式建议用 LLVM

[target.x86_64-pc-windows-msvc]
# Windows MSVC 平台：Release 模式使用 LLVM，Debug 模式可用 Cranelift
# 由于 Cranelift + Release 可能出现链接错误，这里默认使用 LLVM
rustflags = [
    "-C", "link-arg=/STACK:8000000",
    "-C", "link-arg=/MANIFEST:NO",
    # 使用 LLVM 的 LLD 链接器替代默认链接器，大幅提升链接速度
    "-C", "linker=lld-link",
    # 减少调试信息以加速编译
    "-C", "debuginfo=0",
]

# 如果你想在 Debug 模式下使用 Cranelift，可以临时设置环境变量：
# set RUSTFLAGS=-Zcodegen-backend=cranelift
# cargo build

[target.x86_64-pc-windows-gnu]
linker = "x86_64-w64-mingw32-gcc"
rustflags = [
    "-C", "link-args=-Wl,--stack,8000000",
    "-C", "link-arg=-fuse-ld=lld",
    "-C", "debuginfo=0"
]
